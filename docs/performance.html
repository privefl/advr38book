<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Advanced R Course</title>
  <meta name="description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France (2018).">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Advanced R Course" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://privefl.github.io/advr38book/" />
  <meta property="og:image" content="https://privefl.github.io/advr38book/images/hexsticker.png" />
  <meta property="og:description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France (2018)." />
  <meta name="github-repo" content="privefl/advr38book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Advanced R Course" />
  <meta name="twitter:site" content="@privefl" />
  <meta name="twitter:description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France (2018)." />
  <meta name="twitter:image" content="https://privefl.github.io/advr38book/images/hexsticker.png" />

<meta name="author" content="Florian Privé">


<meta name="date" content="2018-02-22">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="data-analysis-with-the-tidyverse.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.0/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.4/datatables.js"></script>
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.16/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./index.html">Advanced R Course [WORK IN PROGRESS]</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#author"><i class="fa fa-check"></i>Author</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i><b>1.1</b> Prerequisites</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#content"><i class="fa fa-check"></i><b>1.2</b> Content</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#useful-resources"><i class="fa fa-check"></i><b>1.3</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="good-practices.html"><a href="good-practices.html"><i class="fa fa-check"></i><b>2</b> Good practices</a><ul>
<li class="chapter" data-level="2.1" data-path="good-practices.html"><a href="good-practices.html#coding-style"><i class="fa fa-check"></i><b>2.1</b> Coding style</a><ul>
<li class="chapter" data-level="2.1.1" data-path="good-practices.html"><a href="good-practices.html#naming"><i class="fa fa-check"></i><b>2.1.1</b> Naming</a></li>
<li class="chapter" data-level="2.1.2" data-path="good-practices.html"><a href="good-practices.html#spacing"><i class="fa fa-check"></i><b>2.1.2</b> Spacing</a></li>
<li class="chapter" data-level="2.1.3" data-path="good-practices.html"><a href="good-practices.html#indenting"><i class="fa fa-check"></i><b>2.1.3</b> Indenting</a></li>
<li class="chapter" data-level="2.1.4" data-path="good-practices.html"><a href="good-practices.html#long-lines"><i class="fa fa-check"></i><b>2.1.4</b> Long lines</a></li>
<li class="chapter" data-level="2.1.5" data-path="good-practices.html"><a href="good-practices.html#other"><i class="fa fa-check"></i><b>2.1.5</b> Other</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="good-practices.html"><a href="good-practices.html#rstudio"><i class="fa fa-check"></i><b>2.2</b> RStudio</a></li>
<li class="chapter" data-level="2.3" data-path="good-practices.html"><a href="good-practices.html#version-control-git"><i class="fa fa-check"></i><b>2.3</b> Version control (Git)</a><ul>
<li class="chapter" data-level="2.3.1" data-path="good-practices.html"><a href="good-practices.html#why-use-git"><i class="fa fa-check"></i><b>2.3.1</b> Why use Git?</a></li>
<li class="chapter" data-level="2.3.2" data-path="good-practices.html"><a href="good-practices.html#git"><i class="fa fa-check"></i><b>2.3.2</b> Git</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="good-practices.html"><a href="good-practices.html#getting-help"><i class="fa fa-check"></i><b>2.4</b> Getting help</a><ul>
<li class="chapter" data-level="2.4.1" data-path="good-practices.html"><a href="good-practices.html#help-yourself-learn-how-to-debug"><i class="fa fa-check"></i><b>2.4.1</b> Help yourself, learn how to debug</a></li>
<li class="chapter" data-level="2.4.2" data-path="good-practices.html"><a href="good-practices.html#external-help"><i class="fa fa-check"></i><b>2.4.2</b> External help</a></li>
<li class="chapter" data-level="2.4.3" data-path="good-practices.html"><a href="good-practices.html#exercises"><i class="fa fa-check"></i><b>2.4.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="r-programming.html"><a href="r-programming.html"><i class="fa fa-check"></i><b>3</b> R programming</a><ul>
<li class="chapter" data-level="3.1" data-path="r-programming.html"><a href="r-programming.html#common-mistakes"><i class="fa fa-check"></i><b>3.1</b> Common mistakes</a><ul>
<li class="chapter" data-level="3.1.1" data-path="r-programming.html"><a href="r-programming.html#equality"><i class="fa fa-check"></i><b>3.1.1</b> Equality</a></li>
<li class="chapter" data-level="3.1.2" data-path="r-programming.html"><a href="r-programming.html#arguments"><i class="fa fa-check"></i><b>3.1.2</b> Arguments</a></li>
<li class="chapter" data-level="3.1.3" data-path="r-programming.html"><a href="r-programming.html#others"><i class="fa fa-check"></i><b>3.1.3</b> Others</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="r-programming.html"><a href="r-programming.html#r-base-objects"><i class="fa fa-check"></i><b>3.2</b> R base objects</a><ul>
<li class="chapter" data-level="3.2.1" data-path="r-programming.html"><a href="r-programming.html#types"><i class="fa fa-check"></i><b>3.2.1</b> Types</a></li>
<li class="chapter" data-level="3.2.2" data-path="r-programming.html"><a href="r-programming.html#exercise"><i class="fa fa-check"></i><b>3.2.2</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="r-programming.html"><a href="r-programming.html#base-objects-and-accessors"><i class="fa fa-check"></i><b>3.3</b> Base objects and accessors</a><ul>
<li class="chapter" data-level="3.3.1" data-path="r-programming.html"><a href="r-programming.html#objects"><i class="fa fa-check"></i><b>3.3.1</b> Objects</a></li>
<li class="chapter" data-level="3.3.2" data-path="r-programming.html"><a href="r-programming.html#accessors"><i class="fa fa-check"></i><b>3.3.2</b> Accessors</a></li>
<li class="chapter" data-level="3.3.3" data-path="r-programming.html"><a href="r-programming.html#exercises-1"><i class="fa fa-check"></i><b>3.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="r-programming.html"><a href="r-programming.html#useful-r-base-functions"><i class="fa fa-check"></i><b>3.4</b> Useful R base functions</a><ul>
<li class="chapter" data-level="3.4.1" data-path="r-programming.html"><a href="r-programming.html#general"><i class="fa fa-check"></i><b>3.4.1</b> General</a></li>
<li class="chapter" data-level="3.4.2" data-path="r-programming.html"><a href="r-programming.html#sequence-and-vector-operations"><i class="fa fa-check"></i><b>3.4.2</b> Sequence and vector operations</a></li>
<li class="chapter" data-level="3.4.3" data-path="r-programming.html"><a href="r-programming.html#character-operations"><i class="fa fa-check"></i><b>3.4.3</b> Character operations</a></li>
<li class="chapter" data-level="3.4.4" data-path="r-programming.html"><a href="r-programming.html#logical-operators"><i class="fa fa-check"></i><b>3.4.4</b> Logical operators</a></li>
<li class="chapter" data-level="3.4.5" data-path="r-programming.html"><a href="r-programming.html#exercises-2"><i class="fa fa-check"></i><b>3.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="r-programming.html"><a href="r-programming.html#environments-and-scoping"><i class="fa fa-check"></i><b>3.5</b> Environments and scoping</a></li>
<li class="chapter" data-level="3.6" data-path="r-programming.html"><a href="r-programming.html#attributes-and-classes"><i class="fa fa-check"></i><b>3.6</b> Attributes and classes</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-analysis-with-the-tidyverse.html"><a href="data-analysis-with-the-tidyverse.html"><i class="fa fa-check"></i><b>4</b> Data analysis with the tidyverse</a><ul>
<li class="chapter" data-level="4.1" data-path="data-analysis-with-the-tidyverse.html"><a href="data-analysis-with-the-tidyverse.html#program"><i class="fa fa-check"></i><b>4.1</b> Program</a></li>
<li class="chapter" data-level="4.2" data-path="data-analysis-with-the-tidyverse.html"><a href="data-analysis-with-the-tidyverse.html#other-resources"><i class="fa fa-check"></i><b>4.2</b> Other resources</a></li>
<li class="chapter" data-level="4.3" data-path="data-analysis-with-the-tidyverse.html"><a href="data-analysis-with-the-tidyverse.html#other-tidy-packages"><i class="fa fa-check"></i><b>4.3</b> Other “tidy” packages</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="performance.html"><a href="performance.html"><i class="fa fa-check"></i><b>5</b> Performance</a><ul>
<li class="chapter" data-level="5.1" data-path="performance.html"><a href="performance.html#rs-memory-management"><i class="fa fa-check"></i><b>5.1</b> R’s memory management</a></li>
<li class="chapter" data-level="5.2" data-path="performance.html"><a href="performance.html#early-advice"><i class="fa fa-check"></i><b>5.2</b> Early advice</a><ul>
<li class="chapter" data-level="5.2.1" data-path="performance.html"><a href="performance.html#never-grow-a-vector"><i class="fa fa-check"></i><b>5.2.1</b> NEVER GROW A VECTOR</a></li>
<li class="chapter" data-level="5.2.2" data-path="performance.html"><a href="performance.html#access-columns-of-a-matrix"><i class="fa fa-check"></i><b>5.2.2</b> Access columns of a matrix</a></li>
<li class="chapter" data-level="5.2.3" data-path="performance.html"><a href="performance.html#use-the-right-function"><i class="fa fa-check"></i><b>5.2.3</b> Use the right function</a></li>
<li class="chapter" data-level="5.2.4" data-path="performance.html"><a href="performance.html#do-not-try-to-optimize-everything"><i class="fa fa-check"></i><b>5.2.4</b> Do not try to optimize everything</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="performance.html"><a href="performance.html#vectorization"><i class="fa fa-check"></i><b>5.3</b> Vectorization</a><ul>
<li class="chapter" data-level="5.3.1" data-path="performance.html"><a href="performance.html#exercises-3"><i class="fa fa-check"></i><b>5.3.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="performance.html"><a href="performance.html#algorithms-data-structures"><i class="fa fa-check"></i><b>5.4</b> Algorithms &amp; data structures</a></li>
<li class="chapter" data-level="5.5" data-path="performance.html"><a href="performance.html#rcpp"><i class="fa fa-check"></i><b>5.5</b> Rcpp</a></li>
<li class="chapter" data-level="5.6" data-path="performance.html"><a href="performance.html#linear-algebra"><i class="fa fa-check"></i><b>5.6</b> Linear algebra</a></li>
<li class="chapter" data-level="5.7" data-path="performance.html"><a href="performance.html#exos"><i class="fa fa-check"></i><b>5.7</b> Exercises</a></li>
<li class="chapter" data-level="5.8" data-path="performance.html"><a href="performance.html#parallel"><i class="fa fa-check"></i><b>5.8</b> Parallel</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced R Course</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="performance" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Performance</h1>
<p>Some resources used here or for further reading:</p>
<ul>
<li><a href="https://adv-r.hadley.nz/performance.html">Advanced R</a></li>
<li><a href="https://bookdown.org/csgillespie/efficientR/">Efficient R programming</a></li>
</ul>
<p>The people who say that R is <em>just always slow</em> are usually not great R programmers. It is true that writing inefficient R code is easy, yet writing efficient R code is also possible when you know what you’re doing. In this chapter, you will learn how to write R(cpp) code that is fast.</p>
<!-- Some years ago, when introducing the Julia language, some really unfair benchmark comparisons were released (e.g. with loops where obvious and simpler vectorized code would have been much faster). I'm still mad at Julia for this and [I am not the only one](https://matloff.wordpress.com/2014/05/21/r-beats-python-r-beats-julia-anyone-else-wanna-challenge-r/). -->
<div id="rs-memory-management" class="section level2">
<h2><span class="header-section-number">5.1</span> R’s memory management</h2>
<p>See <a href="https://adv-r.hadley.nz/names-values.html">this new chapter of Advanced R</a>.</p>
</div>
<div id="early-advice" class="section level2">
<h2><span class="header-section-number">5.2</span> Early advice</h2>
<div id="never-grow-a-vector" class="section level3">
<h3><span class="header-section-number">5.2.1</span> NEVER GROW A VECTOR</h3>
<p>Example computing the cumulative sums of a vector:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="fl">1e4</span>)  <span class="co"># Try also with n = 1e5</span>
<span class="kw">system.time</span>({
  current_sum &lt;-<span class="st"> </span><span class="dv">0</span>
  res &lt;-<span class="st"> </span><span class="kw">c</span>()
  for (x_i in x) {
    current_sum &lt;-<span class="st"> </span>current_sum +<span class="st"> </span>x_i
    res &lt;-<span class="st"> </span><span class="kw">c</span>(res, current_sum)
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.165   0.000   0.165</code></pre>
<p>Here, at each iterating, you reallocating a vector (of increasing size). It makes your computation quadratic with the size of <code>x</code> (if you multiply the size by 2, you can expect the execution time to be multiplied by 4, for large sample sizes), whereas it should be only linear. Indeed, we will see that execution time can be composed of computation time but also allocation time.</p>
<p>A good solution is to always pre-allocating your results (if you know the size):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  current_sum &lt;-<span class="st"> </span><span class="dv">0</span>
  res2 &lt;-<span class="st"> </span><span class="kw">double</span>(<span class="kw">length</span>(x))
  for (i in <span class="kw">seq_along</span>(x)) {
    current_sum &lt;-<span class="st"> </span>current_sum +<span class="st"> </span>x[i]
    res2[i] &lt;-<span class="st"> </span>current_sum
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.003   0.000   0.003</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all.equal</span>(res2, res)</code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<p>An even better solution would be to avoid the loop by using a vectorized function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(res3 &lt;-<span class="st"> </span><span class="kw">cumsum</span>(x))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;       0       0       0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all.equal</span>(res3, res)</code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="fl">1e7</span>)
<span class="kw">system.time</span>(<span class="kw">cumsum</span>(x))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.050   0.007   0.057</code></pre>
<p>As a second example, let us generate a matrix of uniform values (max changing for every column):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="fl">1e3</span>
max &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">1000</span>
<span class="kw">system.time</span>({
  mat &lt;-<span class="st"> </span><span class="ot">NULL</span>
  for (m in max) {
    mat &lt;-<span class="st"> </span><span class="kw">cbind</span>(mat, <span class="kw">runif</span>(n, <span class="dt">max =</span> m))
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.627   0.134   0.761</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(mat, <span class="dv">2</span>, max)[<span class="dv">1</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>#&gt;  [1] 0.9993332 1.9985237 2.9994365 3.9997184 4.9904743 5.9943320 6.9972863 7.9988587 8.9911043
#&gt; [10] 9.9713847</code></pre>
<p>So, we can either pre-allocate a list or a matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  l &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(max))
  for (i in <span class="kw">seq_along</span>(max)) {
    l[[i]] &lt;-<span class="st"> </span><span class="kw">runif</span>(n, <span class="dt">max =</span> max[i])
  }
  mat2 &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;cbind&quot;</span>, l)
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.032   0.001   0.033</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(mat2, <span class="dv">2</span>, max)[<span class="dv">1</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>#&gt;  [1] 0.9979242 1.9988645 2.9956157 3.9998911 4.9991103 5.9980155 6.9943872 7.9995980 8.9931470
#&gt; [10] 9.9907720</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  mat3 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, n, <span class="kw">length</span>(max))
  for (i in <span class="kw">seq_along</span>(max)) {
    mat3[, i] &lt;-<span class="st"> </span><span class="kw">runif</span>(n, <span class="dt">max =</span> max[i])
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.032   0.003   0.035</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(mat3, <span class="dv">2</span>, max)[<span class="dv">1</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>#&gt;  [1] 0.9997143 1.9987226 2.9949490 3.9975455 4.9980714 5.9950067 6.9942354 7.9770524 8.9958982
#&gt; [10] 9.9974765</code></pre>
<p>Instead of pre-allocating yourself, you can use <code>sapply</code> (or <code>lapply</code> and calling <code>do.call()</code> after, as previously done):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
  mat4 &lt;-<span class="st"> </span><span class="kw">sapply</span>(max, function(m) <span class="kw">runif</span>(n, <span class="dt">max =</span> m))
)</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.033   0.000   0.033</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(mat4, <span class="dv">2</span>, max)[<span class="dv">1</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>#&gt;  [1] 0.9990536 1.9915353 2.9941131 3.9983607 4.9957052 5.9995355 6.9974357 7.9698145 8.9942085
#&gt; [10] 9.9876547</code></pre>
</div>
<div id="access-columns-of-a-matrix" class="section level3">
<h3><span class="header-section-number">5.2.2</span> Access columns of a matrix</h3>
<p>When you do computations on a matrix, recall that a matrix is just a vector with some dimensions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vec &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">20</span>
<span class="kw">dim</span>(vec) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>)
vec</code></pre></div>
<pre><code>#&gt;      [,1] [,2] [,3] [,4] [,5]
#&gt; [1,]    1    5    9   13   17
#&gt; [2,]    2    6   10   14   18
#&gt; [3,]    3    7   11   15   19
#&gt; [4,]    4    8   12   16   20</code></pre>
<p>So, as you can see in this example, R matrices are column-oriented, which means that elements of the same column are stored contiguously in memory. Therefore, accessing elements of the same column is fast.</p>
</div>
<div id="use-the-right-function" class="section level3">
<h3><span class="header-section-number">5.2.3</span> Use the right function</h3>
<p>Often, to optimize your code, you can simply find the right function in the right package to do what you need to do.</p>
<p>For example, using <code>rowMeans(x)</code> instead of <code>apply(x, 1, mean)</code> can save you a lot of time. If you want more efficient functions that apply to rows and columns of matrices, you can check <a href="https://github.com/HenrikBengtsson/matrixStats">package <strong>matrixStats</strong></a>.</p>
<p>Another example is when reading large text files. In such cases, prefer using <code>data.table::fread()</code> rather than <code>read.table()</code>.</p>
<p>Generally, packages that uses C/Rcpp are efficient.</p>
</div>
<div id="do-not-try-to-optimize-everything" class="section level3">
<h3><span class="header-section-number">5.2.4</span> Do not try to optimize everything</h3>
<blockquote>
<p>“Programmers waste enormous amounts of time thinking about, or worrying about, the speed of noncritical parts of their programs, and these attempts at efficiency actually have a strong negative impact when debugging and maintenance are considered.”</p>
<p>— Donald Knuth.</p>
</blockquote>
<p>If you try to optimize each and every part of your code, you will end up losing a lot of time writing it and it will probably less readable.</p>
<p>R is great at prototyping quickly because you can write code in a concise and easy way. Begin by doing just that. If performance matters, then profile your code to see which part of your code is taking too much time and optimize only this part!</p>
<p>Learn more on how to profile your code in RStudio in <a href="https://support.rstudio.com/hc/en-us/articles/218221837-Profiling-with-RStudio">this article</a>.</p>
<!-- ```{r, echo=FALSE} -->
<!-- knitr::include_graphics("https://twitter.com/twitter/statuses/874522268331671557") -->
<!-- ``` -->
</div>
</div>
<div id="vectorization" class="section level2">
<h2><span class="header-section-number">5.3</span> Vectorization</h2>
<p>See <a href="http://www.noamross.net/blog/2014/4/16/vectorization-in-r--why.html">this great blog post by Noam Ross</a> to understand vectorization.</p>
<div id="exercises-3" class="section level3">
<h3><span class="header-section-number">5.3.1</span> Exercises</h3>
<p>Monte-Carlo integration (example from <a href="https://bookdown.org/csgillespie/efficientR/programming.html#vectorised-code">book Efficient R programming</a>)</p>
<p>Suppose we wish to estimate the integral <span class="math inline">\(\int_0^1 x^2 dx\)</span> using a Monte-Carlo method. Essentially, we throw darts at the curve and count the number of darts that fall below the curve (as in the following figure).</p>
<p><img src="https://bookdown.org/csgillespie/efficientR/_main_files/figure-html/3-1-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><em>Monte Carlo Integration pseudo-code</em></p>
<ol style="list-style-type: decimal">
<li>Initialize: <code>hits = 0</code></li>
<li><strong>for i in 1:N</strong></li>
<li><span class="math inline">\(~~\)</span> Generate two random numbers, <span class="math inline">\(U_1\)</span> and <span class="math inline">\(U_2\)</span>, between 0 and 1</li>
<li><span class="math inline">\(~~\)</span> If <span class="math inline">\(U_2 &lt; U_1^2\)</span>, then <code>hits = hits + 1</code></li>
<li><strong>end for</strong></li>
<li>Area estimate = <code>hits / N</code></li>
</ol>
<p>Naively implementing this Monte-Carlo algorithm in R would typically lead to something like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">monte_carlo &lt;-<span class="st"> </span>function(N) {
  
  hits &lt;-<span class="st"> </span><span class="dv">0</span>
  for (i in <span class="kw">seq_len</span>(N)) {
    u1 &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>)
    u2 &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>)
    if (u1 ^<span class="st"> </span><span class="dv">2</span> &gt;<span class="st"> </span>u2) {
      hits &lt;-<span class="st"> </span>hits +<span class="st"> </span><span class="dv">1</span>
    }
  }
  
  hits /<span class="st"> </span>N
}</code></pre></div>
<p>This takes a few seconds for <code>N = 1e6</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">N &lt;-<span class="st"> </span><span class="fl">1e6</span>
<span class="kw">system.time</span>(<span class="kw">monte_carlo</span>(N))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   3.622   0.008   3.632</code></pre>
<p><strong>Your task: Find a vectorized solution for this problem:</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(<span class="kw">monte_carlo_vec</span>(N))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.06    0.00    0.06</code></pre>
<hr />
<p>You have this data and this working code (a loop) that is slow</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mydf &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata/one-million.rds&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;advr38pkg&quot;</span>))

QRA_3Dmatrix &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">max</span>(mydf$ID), <span class="kw">max</span>(mydf$Volume), <span class="dv">2</span>))  

for (i in <span class="kw">seq_len</span>(<span class="kw">nrow</span>(mydf))) {
  <span class="co"># Row corresponds to IDcell </span>
  row    &lt;-<span class="st"> </span>mydf[[i, <span class="dv">1</span>]]    
  <span class="co"># Column corresponds to the volume class</span>
  column &lt;-<span class="st"> </span>mydf[[i, <span class="dv">3</span>]]      
  <span class="co"># Number of events, initially zero, then +1</span>
  QRA_3Dmatrix[row, column, <span class="dv">1</span>] &lt;-<span class="st"> </span>QRA_3Dmatrix[row, column, <span class="dv">1</span>] +<span class="st"> </span><span class="dv">1</span>  
  <span class="co"># Sum energy </span>
  QRA_3Dmatrix[row, column, <span class="dv">2</span>] &lt;-<span class="st"> </span>QRA_3Dmatrix[row, column, <span class="dv">2</span>] +<span class="st"> </span>
<span class="st">    </span><span class="dv">1</span> -<span class="st"> </span><span class="fl">1.358</span> /<span class="st"> </span>(<span class="dv">1</span> +<span class="st"> </span><span class="kw">exp</span>( (<span class="dv">1000</span> *<span class="st"> </span>mydf[[i, <span class="dv">2</span>]] -<span class="st"> </span><span class="dv">129000</span>) /<span class="st"> </span><span class="dv">120300</span> ))
}</code></pre></div>
<p>Rewrite this code in a vectorized way (avoiding the loop). Remember to test on a smaller set at the beginning.</p>
</div>
</div>
<div id="algorithms-data-structures" class="section level2">
<h2><span class="header-section-number">5.4</span> Algorithms &amp; data structures</h2>
<p>Sometimes, getting the right data structure (e.g. using a matrix instead of a data frame or integers instead of characters) can save you some computation time.</p>
<p>Is your algorithm doing some redundant computations making it e.g. quadratic instead of linear with respect to the dimension of your data?</p>
<p>See exercises (section <a href="performance.html#exos">5.7</a>) for some insights.</p>
</div>
<div id="rcpp" class="section level2">
<h2><span class="header-section-number">5.5</span> Rcpp</h2>
<p>See <a href="https://privefl.github.io/R-presentation/Rcpp.html">this presentation</a>.</p>
</div>
<div id="linear-algebra" class="section level2">
<h2><span class="header-section-number">5.6</span> Linear algebra</h2>
<p>In R, prefer using <code>crossprod(X)</code> and <code>tcrossprod(X)</code> instead of <code>t(X) %*% X</code> and <code>X %*% t(X)</code>. Also using <code>A %*% (B %*% y)</code> and <code>solve(A, y)</code> will be faster than <code>A %*% B %*% y</code> and <code>solve(A) %*% y</code>.</p>
<p>Don’t re-implement linear algebra operations (such as matrix products) yourself. There exist some highly optimized libraries for this. If you want to use linear algebra in Rcpp, try <a href="http://dirk.eddelbuettel.com/code/rcpp.armadillo.html">RcppArmadillo</a> or <a href="http://dirk.eddelbuettel.com/code/rcpp.eigen.html">RcppEigen</a>.</p>
<p>If you want to use some optimized multi-threaded linear library, you can try <a href="https://mran.revolutionanalytics.com/documents/rro/multithread">Microsoft R Open</a>.</p>
</div>
<div id="exos" class="section level2">
<h2><span class="header-section-number">5.7</span> Exercises</h2>
<p>Generate <span class="math inline">\(10^8\)</span> (begin with <span class="math inline">\(10^4\)</span>) steps of the process described by the formula:<span class="math display">\[X(0)=0\]</span><span class="math display">\[X(t+1)=X(t)+Y(t)\]</span> where <span class="math inline">\(Y(t)\)</span> are independent random variables with the distribution <span class="math inline">\(N(0,1)\)</span>. Then, calculate in what percentage of indices <span class="math inline">\(t\)</span> the value of <span class="math inline">\(X(t)\)</span> was negative. You don’t need to store values of <span class="math inline">\(X\)</span> if you don’t want to. What would be the benefit of writing an Rcpp function over a simple vectorized R function?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1</span>)
<span class="kw">system.time</span>(p &lt;-<span class="st"> </span>advr38pkg::<span class="kw">random_walk_neg_prop</span>(<span class="fl">1e7</span>))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.508   0.000   0.509</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p</code></pre></div>
<pre><code>#&gt; [1] 0.3400444</code></pre>
<hr />
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(mtcars)
ind &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">nrow</span>(mat))
mat_big &lt;-<span class="st"> </span>mat[<span class="kw">rep</span>(ind, <span class="dv">1000</span>), ]  ## 1000 times bigger dataset
last_row &lt;-<span class="st"> </span>mat_big[<span class="kw">nrow</span>(mat_big), ]</code></pre></div>
<p>Speed up these loops:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  for (j in <span class="dv">1</span>:<span class="kw">ncol</span>(mat_big)) {
    for (i in <span class="dv">1</span>:<span class="kw">nrow</span>(mat_big)) {
      mat_big[i, j] &lt;-<span class="st"> </span><span class="dv">10</span> *<span class="st"> </span>mat_big[i, j] *<span class="st"> </span>last_row[j]
    }
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.438   0.001   0.439</code></pre>
<hr />
<p>Why <code>colSums()</code> on a whole matrix is faster than on only half of it?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m0 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(<span class="fl">1e6</span>), <span class="fl">1e3</span>, <span class="fl">1e3</span>)
microbenchmark::<span class="kw">microbenchmark</span>(
  <span class="kw">colSums</span>(m0[, <span class="dv">1</span>:<span class="dv">500</span>]), 
  <span class="kw">colSums</span>(m0)
)</code></pre></div>
<pre><code>#&gt; Unit: microseconds
#&gt;                  expr      min        lq     mean    median        uq      max neval
#&gt;  colSums(m0[, 1:500]) 2183.098 2469.6220 2721.803 2592.1935 2680.7870 6076.678   100
#&gt;           colSums(m0)  787.182  804.8855  835.075  830.4825  853.0425 1179.620   100</code></pre>
<hr />
<p>Try to speed up this code by vectorizing it first. Then, recode it in Rcpp and benchmark all the solutions you came up with.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">M &lt;-<span class="st"> </span><span class="dv">50</span>
step1 &lt;-<span class="st"> </span><span class="kw">runif</span>(M)
A &lt;-<span class="st"> </span><span class="kw">rnorm</span>(M)
N &lt;-<span class="st"> </span><span class="fl">1e4</span>

tau &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, N +<span class="st"> </span><span class="dv">1</span>, M)
tau[<span class="dv">1</span>, ] &lt;-<span class="st"> </span>A
for (j in <span class="dv">1</span>:M) {
  for (i in <span class="dv">2</span>:<span class="kw">nrow</span>(tau)) {
    tau[i, j] &lt;-<span class="st"> </span>tau[i -<span class="st"> </span><span class="dv">1</span>, j] +<span class="st"> </span>step1[j] *<span class="st"> </span><span class="fl">1.0025</span>^(i -<span class="st"> </span><span class="dv">2</span>)
  }
} </code></pre></div>
<hr />
<p>Make a fast function that counts the number of elements between a sequence of breaks. Can you do it in base R? Try also implementing it in Rcpp. How can you implement a solution whose computation time doesn’t depend on the number of breaks? [Which are the special cases that you should consider?]</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">10</span>, <span class="dt">size =</span> <span class="fl">1e4</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)
breaks &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">9</span>, <span class="fl">9.5</span>, <span class="dv">10</span>)
<span class="kw">table</span>(<span class="kw">cut</span>(x, breaks))</code></pre></div>
<pre><code>#&gt; 
#&gt;    (1,3]    (3,9]  (9,9.5] (9.5,10] 
#&gt;     2082     5925        0      994</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(x, breaks, <span class="dt">plot =</span> <span class="ot">FALSE</span>)$counts  <span class="co"># includes first break</span></code></pre></div>
<pre><code>#&gt; [1] 3081 5925    0  994</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">advr38pkg::<span class="kw">count_by_breaks</span>(x, breaks)</code></pre></div>
<pre><code>#&gt; [1] 2082 5925    0  994</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">advr38pkg::<span class="kw">count_by_breaks_fast</span>(x, breaks)</code></pre></div>
<pre><code>#&gt; [1] 2082 5925    0  994</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">microbenchmark::<span class="kw">microbenchmark</span>(
  <span class="kw">table</span>(<span class="kw">cut</span>(x, breaks)), 
  <span class="kw">hist</span>(x, breaks, <span class="dt">plot =</span> <span class="ot">FALSE</span>)$counts, 
  advr38pkg::<span class="kw">count_by_breaks</span>(x, breaks),
  advr38pkg::<span class="kw">count_by_breaks_fast</span>(x, breaks)
)</code></pre></div>
<pre><code>#&gt; Unit: microseconds
#&gt;                                        expr      min        lq      mean    median        uq
#&gt;                       table(cut(x, breaks)) 2064.228 2109.9745 2208.5694 2174.2980 2228.8795
#&gt;        hist(x, breaks, plot = FALSE)$counts  325.810  342.5375  366.2083  358.5660  386.5025
#&gt;       advr38pkg::count_by_breaks(x, breaks)  333.353  347.0070  408.2932  364.9560  506.2100
#&gt;  advr38pkg::count_by_breaks_fast(x, breaks)  159.588  169.3305  189.0685  178.8645  210.8510
#&gt;       max neval
#&gt;  5166.438   100
#&gt;   460.952   100
#&gt;   576.400   100
#&gt;   360.661   100</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x2 &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">10</span>, <span class="dt">size =</span> <span class="fl">1e5</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)
breaks2 &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dt">length.out =</span> <span class="dv">100</span>)
microbenchmark::<span class="kw">microbenchmark</span>(
  advr38pkg::<span class="kw">count_by_breaks</span>(x2, breaks),
  advr38pkg::<span class="kw">count_by_breaks_fast</span>(x2, breaks),
  advr38pkg::<span class="kw">count_by_breaks</span>(x2, breaks2),
  advr38pkg::<span class="kw">count_by_breaks_fast</span>(x2, breaks2)
)</code></pre></div>
<pre><code>#&gt; Unit: milliseconds
#&gt;                                          expr       min         lq       mean     median         uq
#&gt;        advr38pkg::count_by_breaks(x2, breaks)  3.033415   3.086494   3.219431   3.164821   3.265149
#&gt;   advr38pkg::count_by_breaks_fast(x2, breaks)  1.230184   1.271041   1.340716   1.300095   1.351498
#&gt;       advr38pkg::count_by_breaks(x2, breaks2) 73.783857 109.384141 111.011401 110.075012 111.876148
#&gt;  advr38pkg::count_by_breaks_fast(x2, breaks2)  1.254069   1.305682   1.370925   1.331033   1.380272
#&gt;         max neval
#&gt;    4.492957   100
#&gt;    2.379002   100
#&gt;  161.995309   100
#&gt;    2.275777   100</code></pre>
<hr />
<p>An R user wants to implement some sampling on a sparse matrix and provides this working code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(Matrix)
N &lt;-<span class="st"> </span><span class="dv">100</span>
m &lt;-<span class="st"> </span><span class="kw">Matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> N, <span class="dt">ncol =</span> N)

for (j in <span class="dv">1</span>:N) {
  cols &lt;-<span class="st"> </span><span class="kw">sample</span>((<span class="dv">1</span>:N)[-j], <span class="dv">2</span>)  <span class="co"># 2 columns != j </span>
  m[j, cols] &lt;-<span class="st"> </span><span class="dv">1</span>
}</code></pre></div>
<p>This code is slow; can you find two major reasons why?</p>
<p>How can you more efficiently assign 1s?</p>
<p>Can you use sampling with replacement (which can be easily vectorized) in this example?</p>
<p>Implement faster solutions in R and Rcpp.</p>
<hr />
<p>Make a fast function that returns all prime numbers up to a number <code>N</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">N &lt;-<span class="st"> </span><span class="fl">1e6</span>
<span class="kw">system.time</span>(
  primes &lt;-<span class="st"> </span>advr38pkg::<span class="kw">AllPrimesUpTo</span>(N)
)</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.055   0.000   0.056</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(primes, <span class="dt">pch =</span> <span class="dv">20</span>, <span class="dt">cex =</span> <span class="fl">0.5</span>)</code></pre></div>
<p><img src="performance_files/figure-html/unnamed-chunk-22-1.svg" width="70%" style="display: block; margin: auto;" /></p>
<hr />
<p>Imagine you have a list of animals, which are infected by other individuals:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Make some data</span>
allanimals &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">AnimalID =</span> <span class="kw">c</span>(<span class="st">&quot;a1&quot;</span>, <span class="st">&quot;a2&quot;</span>, <span class="st">&quot;a3&quot;</span>, <span class="st">&quot;a4&quot;</span>, <span class="st">&quot;a5&quot;</span>, <span class="st">&quot;a6&quot;</span>, <span class="st">&quot;a7&quot;</span>, <span class="st">&quot;a8&quot;</span>, <span class="st">&quot;b1&quot;</span>, <span class="st">&quot;b2&quot;</span>, <span class="st">&quot;b3&quot;</span>,
               <span class="st">&quot;b4&quot;</span>, <span class="st">&quot;b5&quot;</span>, <span class="st">&quot;c1&quot;</span>, <span class="st">&quot;c2&quot;</span>, <span class="st">&quot;c3&quot;</span>, <span class="st">&quot;c4&quot;</span>, <span class="st">&quot;d1&quot;</span>, <span class="st">&quot;d2&quot;</span>, <span class="st">&quot;e1&quot;</span>, <span class="st">&quot;e2&quot;</span>, <span class="st">&quot;e3&quot;</span>,
               <span class="st">&quot;e4&quot;</span>, <span class="st">&quot;e5&quot;</span>, <span class="st">&quot;e6&quot;</span>, <span class="st">&quot;f1&quot;</span>, <span class="st">&quot;f2&quot;</span>, <span class="st">&quot;f3&quot;</span>, <span class="st">&quot;f4&quot;</span>, <span class="st">&quot;f5&quot;</span>, <span class="st">&quot;f6&quot;</span>, <span class="st">&quot;f7&quot;</span>),
  <span class="dt">InfectingAnimal =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&quot;a1&quot;</span>, <span class="st">&quot;a2&quot;</span>, <span class="st">&quot;a3&quot;</span>, <span class="st">&quot;a4&quot;</span>, <span class="st">&quot;a5&quot;</span>, <span class="st">&quot;a6&quot;</span>, <span class="st">&quot;a7&quot;</span>, <span class="st">&quot;a2&quot;</span>, <span class="st">&quot;b1&quot;</span>,
                      <span class="st">&quot;b2&quot;</span>, <span class="st">&quot;b3&quot;</span>, <span class="st">&quot;b4&quot;</span>, <span class="st">&quot;b3&quot;</span>, <span class="st">&quot;c1&quot;</span>, <span class="st">&quot;c2&quot;</span>, <span class="st">&quot;c3&quot;</span>, <span class="st">&quot;c3&quot;</span>, <span class="st">&quot;d1&quot;</span>,
                      <span class="st">&quot;b1&quot;</span>, <span class="st">&quot;e1&quot;</span>, <span class="st">&quot;e2&quot;</span>, <span class="st">&quot;e3&quot;</span>, <span class="st">&quot;e4&quot;</span>, <span class="st">&quot;e5&quot;</span>, <span class="st">&quot;e1&quot;</span>, <span class="st">&quot;f1&quot;</span>, <span class="st">&quot;f2&quot;</span>, 
                      <span class="st">&quot;f3&quot;</span>, <span class="st">&quot;f4&quot;</span>, <span class="st">&quot;f5&quot;</span>, <span class="st">&quot;f6&quot;</span>), 
  <span class="dt">habitat =</span> <span class="kw">c</span>(1L, 2L, 1L, 2L, 2L, 1L, 3L, 2L, 4L, 5L, 6L, 1L, 2L, 3L, 2L, 3L, 
              2L, 1L, 1L, 2L, 5L, 4L, 1L, 1L, 1L, 1L, 4L, 5L, 4L, 5L, 4L, 3L),
  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>
)
<span class="co"># Check it out</span>
DT::<span class="kw">datatable</span>(allanimals)</code></pre></div>
<div id="htmlwidget-7c01291d376295e8aa06" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7c01291d376295e8aa06">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"],["a1","a2","a3","a4","a5","a6","a7","a8","b1","b2","b3","b4","b5","c1","c2","c3","c4","d1","d2","e1","e2","e3","e4","e5","e6","f1","f2","f3","f4","f5","f6","f7"],[null,"a1","a2","a3","a4","a5","a6","a7","a2","b1","b2","b3","b4","b3","c1","c2","c3","c3","d1","b1","e1","e2","e3","e4","e5","e1","f1","f2","f3","f4","f5","f6"],[1,2,1,2,2,1,3,2,4,5,6,1,2,3,2,3,2,1,1,2,5,4,1,1,1,1,4,5,4,5,4,3]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>AnimalID<\/th>\n      <th>InfectingAnimal<\/th>\n      <th>habitat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>For a given animal (1), you want to get which animal (2) infected (1), and then which animal infected (2), and so on you want to get the whole path of infection.</p>
<p><img src="https://i.stack.imgur.com/oWoOc.jpg" width="20%" style="display: block; margin: auto;" /></p>
<p>For example for animal <code>d2</code>, you want to return:</p>
<pre><code>#&gt;    AnimalID InfectingAnimal habitat
#&gt; 19       d2              d1       1
#&gt; 18       d1              c3       1
#&gt; 16       c3              c2       3
#&gt; 15       c2              c1       2
#&gt; 14       c1              b3       3
#&gt; 11       b3              b2       6
#&gt; 10       b2              b1       5
#&gt; 9        b1              a2       4
#&gt; 2        a2              a1       2
#&gt; 1        a1            &lt;NA&gt;       1</code></pre>
<p>Find an efficient solution to this problem so that your solution could be used for a large dataset.</p>
<hr />
<p>Find a fast method to compute pairwise distances between 2 matrices. A naive R function would be:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">naive_pdist &lt;-<span class="st"> </span>function(A, B) {
  <span class="co"># A: matrix with observation vectors (nrow = number of observations)</span>
  <span class="co"># B: matrix with another set of vectors (e.g. cluster centers)</span>
  result =<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="kw">nrow</span>(B), <span class="dt">nrow =</span> <span class="kw">nrow</span>(A))
  for (i in <span class="dv">1</span>:<span class="kw">nrow</span>(A))
      for (j in <span class="dv">1</span>:<span class="kw">nrow</span>(B))
          result[i,j] =<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">sum</span>( (A[i,] -<span class="st"> </span>B[j,])^<span class="dv">2</span> ))

  result
}</code></pre></div>
<p>To see a comparison of different computation strategies, see <a href="http://blog.felixriedel.com/2013/05/pairwise-distances-in-r/">this nice blog post</a>.</p>
</div>
<div id="parallel" class="section level2">
<h2><span class="header-section-number">5.8</span> Parallel</h2>
<p>I basically always use <code>foreach</code> and recommend to do so. See <a href="https://privefl.github.io/blog/a-guide-to-parallelism-in-r/">my guide to parallelism in R with <code>foreach</code></a>.</p>
<p><strong>Just remember to optimize your code before trying to parallelize it.</strong></p>
<p>Try to parallelize some of your best solutions for the previous exercises.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-analysis-with-the-tidyverse.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/privefl/advr38book/edit/master/performance.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
